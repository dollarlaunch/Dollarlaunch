<div class="container mt-4 mb-3">
  <div class="row">
    <div class="col-md-2">
      <div class="compgn-user-bg">
        <center><img src="/user.png" class="user-dmy"></center>
        <p class="mt-2 mb-0 text-center">By <%=  @campaign.user.username %></p>
        <center><small><%= time_ago_in_words(@campaign.created_at) %> ago</small></center>
      </div>
    </div>
    <div class="col-md-10 mb-3">
      <h3><%= @campaign.title  %></h3>
      <p><%= @campaign.blurb %></p>
    </div>
  </div>
</div>
<div class="container mb-3">
  <div class="row">
    <div class="col-md-8 mb-2">
        <%= image_tag(@campaign.image.url, class:'cmpgn-img') %>
    </div>
    <div class="col-md-4">
      <div class="cmpgn-top-right-side">
        <p class="mb-0 mt-2">Pledge Amount</p>
        <small class="text-muted"><%= @campaign.pledge_amount %></small>
        <hr>
        <p class="mb-0">No of Participants</p>
        <small class="text-muted"><%= @campaign.no_of_participants  %></small>
        <hr>
        <p class="mb-0">Pledge Deadline</p>
        <small class="text-muted"><%= @campaign.pledge_deadline %></small>
        <hr>
        <% if current_user.admin == true  %>
          <p class="mb-0">Status</p>
          <small class="text-muted"><%= @campaign.status %></small>
        <% end %>
      </div>
      <button class="btn btn-primary btn-block mt-3">Back this project</button>
    </div>
  </div>
</div>
<div class="container mt-5">
	<nav>
    <div class="nav nav-tabs nav-fill cmpg-tab" id="nav-tab" role="tablist">
      <a class="nav-item nav-link cmpgn-tb active" id="nav-campaign-tab" data-toggle="tab" href="#nav-campaign" role="tab" aria-controls="nav-campaign" aria-selected="true">Campaign</a>
      <a class="nav-item nav-link cmpgn-tb" id="nav-milestone-tab" data-toggle="tab" href="#nav-milestone" role="tab" aria-controls="nav-milestone" aria-selected="false">Milestones</a>
      <a class="nav-item nav-link cmpgn-tb" id="nav-champion-tab" data-toggle="tab" href="#nav-champion" role="tab" aria-controls="nav-champion" aria-selected="false">Project Champion</a>
    </div>
	</nav>
</div>
<div class="container mt-3">
  <div class="tab-content py-3 px-3 px-sm-0" id="nav-tabContent">
    <div class="tab-pane fade show active" id="nav-campaign" role="tabpanel" aria-labelledby="nav-campaign-tab">
      <div class="row">
        <div class="col-md-8">
          <p>
            <%= @campaign.description %>
          </p>
        </div>
        <div class="col-md-4">
    			<div class="cmpgn-right">
            <p class="mb-0">Location</p>
            <small class="text-muted"><%= @campaign.location %></small>
            <hr>
            <p class="mb-0">Goal</p>
            <small class="text-muted"><%= @campaign.goal %></small>
            <hr>
            <p class="mb-0">Category</p>
            <small class="text-muted" class='badge badge-primary'><%= @campaign.category.name %></small>
    			</div>
        </div>
      </div>
    </div>
		<div class="tab-pane fade" id="nav-milestone" role="tabpanel" aria-labelledby="nav-milestone-tab">
		  <%= @anchor %>
      <% @campaign.milestones.each_with_index do |milestone, index| %>
        <div class="card bg-light text-dark mt-3 mb-3">
          <div class="card-body">
            <h5 class="mb-0">
              Milestone <%= index + 1 %>
            <i class="fas fa-plus-square new-iplus mil-next<%= milestone.id %>"></i>
            </h5>
            <div class="mil-dec<%= milestone.id %>">
              <hr>
            	<div class="row">
                <div class="col-md-8">
                  <h3><%= milestone.title %></h3>
                  <p><%= milestone.description %></p>
                    <div id="demo<%= milestone.id %>" class="carousel slide mb-3" data-ride="carousel">
                      <div class="carousel-inner">
                        <% milestone.images.each_with_index  do |image, index| %>
                          <div class="carousel-item <%= "active" if index == 0 %>">
                            <%= image_tag(image.image.url) %>
                          </div>
                        <% end %>
                      </div>
                      <a class="carousel-control-prev" href="#demo<%= milestone.id %>" data-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                      </a>
                      <a class="carousel-control-next" href="#demo<%= milestone.id %>" data-slide="next">
                        <span class="carousel-control-next-icon"></span>
                      </a>
                    </div>
                    <%= video_tag((milestone.video.url), controls: '', width:"100%") %>
                  </div>
                  <div class="col-md-4">
                    <div class="cmpgn-right">
                      <p class="mb-0">Milestone Duration</p>
                      <small class="text-muted"><%= milestone.duration_limit %></small>
                      <small class="text-muted"><%= milestone.duration_type %></small>
                      <hr>
                      <p class="mb-0">Milestone Budget</p>
                      <small class="text-muted"><%= milestone.budget %></small>
                    </div>
                  </div>
              </div>
            </div>
  				</div>
  			</div>
      <% end %>
	  </div>
	  <div class="tab-pane fade" id="nav-champion" role="tabpanel" aria-labelledby="nav-champion-tab">
      <div class="row">
        <div class="col-md-8">
          <% if @campaign.projectchampionstatus == 'Disable' %>
            You, have to make a request to the Project Owner to Activate the <span class="badge badge-primary">Project Champion Feature</span>
          <% end %>
          <% if @campaign.projectchampionstatus == 'Activate' %>
            <% if @campaign.user.id != current_user.id %>
              <% if !@projectchampionsexist.present? %>
                <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#exampleModal">
                  Become a Project Champion
                </button>
              <% else %>  
                <% @projectchampionsexist.each do |projectchampion| %>
                  <% if projectchampion.user.id == current_user.id && projectchampion.paymentstatus == true %>
                    <span>Congratulations, You are a Project Champion of this Campaign.</span><br>
                    <span class="text-muted">Note: <small>Remaining Amount will be Pledged by the Users you'll invite</small></span>
                    <%= social_share_button_tag(@campaign.title, :url => campaign_url(@campaign), desc: @campaign.blurb) %>
                  <% else %>
                    <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#exampleModal">
                      Become a Project Champion
                    </button>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Project Champion Form</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <%= simple_form_for @projectchampion do |f| %>
                      <h6>Total Amount you'll bring</h6>
                      <small>Project Champion Minimum Amount is: $<%= @campaign.projectchampionminimumamount %></small>
                      <%= f.input :projectchampiontotalamount, required: true, label: false, input_html: { class: 'form control form-control-sm min-value' }  %>
                      <h6>Amount to be paid by you</h6>
                      <%= f.input :projectchampionpaidamount, required: true, label: false, input_html: { class: 'form control form-control-sm paid-by-you', min: 0 }  %>
                      <%= f.hidden_field :campaign_id, value: @campaign.id %>
                      <%= f.hidden_field :user_id, value: current_user.id %>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <%= f.submit class:'btn btn-primary', value:'Proceed' %>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
            <div id="demo" class="carousel slide mb-3 mt-3" data-ride="carousel">
              <div class="carousel-inner">
                <% @campaign.images.each_with_index  do |image, index| %>
                  <div class="carousel-item <%= "active" if index == 0 %>">
                    <%= image_tag(image.image.url) %>
                  </div>
                <% end %>
              </div>
              <a class="carousel-control-prev" href="#demo" data-slide="prev">
                <span class="carousel-control-prev-icon"></span>
              </a>
              <a class="carousel-control-next" href="#demo" data-slide="next">
                <span class="carousel-control-next-icon"></span>
              </a>
            </div>
            <%= video_tag((@campaign.projectchampionvideo.url), controls: '', width:"100%") %>
          <% end %>
        </div>
        <div class="col-md-4">
          <div class="cmpgn-right pb-0">
            <p>Project Champion Feature is: <small class="badge badge-danger"><%= @campaign.projectchampionstatus %></small></p>
          </div>
        </div>
      </div>
    </div>
	</div>
</div>
<div class="container my-3">
	<div class="col-md-6 mx-auto">
    <%= link_to "Back to Projects", campaigns_path, class:'btn btn-primary' %>
    <% if can? :update, @campaign %>
      <%= link_to "Edit Project", edit_campaign_path(@campaign), class:'btn btn btn-primary' %>
    <% end %>
    <% if can? :destroy, @campaign %>
      <%= link_to "Delete Project", campaign_path(@campaign), method: :delete, data: { confirm: 'Are You Sure?' }, class:'btn btn btn-danger' %>
    <% end %>
  </div>
</div>
<script>
  $(document).ready(function() {
    <% @campaign.milestones.each do |milestone| %>
      $(".mil-dec<%=milestone.id%>").hide();
        $(".mil-next<%=milestone.id%>").click(function(){
          $(".mil-dec<%=milestone.id%>").slideToggle("500");
          $("i", this).toggleClass("fas fa-plus-square fas fa-minus-square");
        })
    <%end%>
  });
  var minval = <%= @campaign.projectchampionminimumamount %>;
  $('.min-value').attr('min',minval);
  $('.min-value').focusout(function(){
    var totalval = $('.min-value').val();
    $('.paid-by-you').attr('max',totalval);
  });
  
  var anchor_value;
  var stripped_url = document.location.toString().split("#");
  if (stripped_url.length > 1){
    anchor_value = stripped_url[1];
    $('#' + anchor_value).addClass('active');
    $('#' + anchor_value).addClass('show');
    $('#nav-champion').addClass('active');
    $('#nav-champion').addClass('show');
    $('#nav-campaign').removeClass('active');
    $('#nav-campaign').removeClass('show');
    $('#nav-campaign-tab').removeClass('active');
    $('#nav-campaign-tab').removeClass('show');
  }
</script>